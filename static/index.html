<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Vis Network | Basic usage</title>

    <script
      type="text/javascript"
      src="https://visjs.github.io/vis-network/standalone/umd/vis-network.min.js"
    ></script>

    <style type="text/css">
      #mynetwork {
        width: 800px;
        height: 800px;
        border: 1px solid lightgray;
        background-color: #1e1e1e;
      }
    </style>
  </head>
  <body>

    <select onchange="selectns()" id="ns">

    </select>

    <div id="mynetwork"></div>


    <script type="text/javascript">

      const selectns = function(){
        const ns = document.getElementById('ns').value
        console.log(ns)
        fetchNs(ns)
      }

      const addns = (ns) => {
        const select = document.getElementById('ns');

        const opt = document.createElement('option');
        opt.value = ns;
        opt.innerHTML = ns;
        select.appendChild(opt);
      }

      fetch(`/ns`)
        .then(res => res.json())
        .then(data => data.forEach(addns))

      const nodes = new vis.DataSet([]);
      const edges = new vis.DataSet([]);

      const fetchNs = ns => {
      fetch(`/pods/${ns}`)
        .then(res => res.json())
        .then(data => data.items)
        .then(pods => {
          nodes.clear()
          edges.clear()

          pods.forEach(pod => {
            console.log(pod)
            const { metadata, spec } = pod
            const { name, namespace } = metadata
            
            //create ns node
            try{
              nodes.add({ id: namespace, label: namespace, shape: "circle",  group: namespace})
            }catch(e){
              console.log(e)
            }

            //create pod node
            nodes.add({ id: name, label: name, group: namespace})

            // add namespace to pod edges
            try{
              edges.add({ from: namespace, to: name})
            }catch(e){
              console.log(e)
            }


            // create containers nodes and edges
            spec.containers.forEach((container, i) => {
              const id = `${name}_${container.name}_${i}`
              nodes.add({
                id,
                label: `${container.name} \n ${container.image}`,
                group: namespace
              })

              edges.add({from: name, to: id})
            })
            
          })  
        })
      }

      // create a network
      var container = document.getElementById("mynetwork");

      var data = {
        nodes: nodes,
        edges: edges,
      };

      var options = {
        nodes: {
          shape: "box",
          shadow: true,
        },
        edges: {
          width: 2,
          shadow: true,
        },
        layout: {
          hierarchical: {
            enabled: true,
            levelSeparation: 250,
            direction: "LR",
            sortMethod: "directed",
          }
        },
      };
      const network = new vis.Network(container, data, options);

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const ns = urlParams.get('ns') || 'default'

      fetchNs(ns)
      
      
      
    </script>

  </body>
</html>

